/*-- DROP ALL TABLE
BEGIN
    -- Drop all tables
    FOR t IN (SELECT table_name FROM user_tables) LOOP
        EXECUTE IMMEDIATE 'DROP TABLE ' || t.table_name || ' CASCADE CONSTRAINTS';
    END LOOP;

    -- Drop all sequences
    FOR s IN (SELECT sequence_name FROM user_sequences) LOOP
        EXECUTE IMMEDIATE 'DROP SEQUENCE ' || s.sequence_name;
    END LOOP;
END;
/

*/
BEGIN
   FOR t IN (SELECT table_name FROM user_tables) LOOP
      EXECUTE IMMEDIATE 'DROP TABLE ' || t.table_name || ' CASCADE CONSTRAINTS';
   END LOOP;
END;
/

alter session set "_ORACLE_SCRIPT"=true;

CREATE USER DIENTHOAI IDENTIFIED BY password;
GRANT CONNECT, RESOURCE, DBA TO DIENTHOAI;

-- Sử dụng Schema

ALTER SESSION SET CURRENT_SCHEMA = DIENTHOAI;

-- Tạo bảng DIENTHOAI
CREATE TABLE DIENTHOAI (
    IMEI VARCHAR2(15) PRIMARY KEY,
    TENDT VARCHAR2(50),
    LOAIDT VARCHAR2(50),
    HOTENKH VARCHAR2(100),
    SDTKH VARCHAR2(15)
);

-- Tạo bảng SUACHUA với NGAYLAP là VARCHAR2
CREATE TABLE SUACHUA (
    MAPSC VARCHAR2(10) PRIMARY KEY,
    NGAYLAP VARCHAR2(10), -- Thay đổi từ DATE sang VARCHAR2(10)
    NOIDUNG VARCHAR2(500),
    IMEI VARCHAR2(15),
    TONGTIEN NUMBER(10, 2) DEFAULT 0,
    FOREIGN KEY (IMEI) REFERENCES DIENTHOAI(IMEI)
);

-- Tạo bảng CONGVIEC
CREATE TABLE CONGVIEC (
    MACV VARCHAR2(10) PRIMARY KEY,
    TENCV VARCHAR2(100),
    DONGIA NUMBER(10, 2)
);

-- Tạo bảng CT_SC
CREATE TABLE CT_SC (
    MAPSC VARCHAR2(10),
    MACV VARCHAR2(10),
    PRIMARY KEY (MAPSC, MACV),
    FOREIGN KEY (MAPSC) REFERENCES SUACHUA(MAPSC),
    FOREIGN KEY (MACV) REFERENCES CONGVIEC(MACV)
);

-- Tạo sequence để sinh mã MAPSC tự động
CREATE SEQUENCE MAPSC_SEQ START WITH 1 INCREMENT BY 1;

-- Tạo trigger để gán MAPSC tự động từ sequence khi chèn mới
CREATE OR REPLACE TRIGGER trg_MAPSC
BEFORE INSERT ON SUACHUA
FOR EACH ROW
BEGIN
    :NEW.MAPSC := LPAD(MAPSC_SEQ.NEXTVAL, 10, '0');
END;
/

-- Tạo trigger để tính tổng tiền sửa chữa
CREATE OR REPLACE TRIGGER trg_update_TONGTIEN
AFTER INSERT OR DELETE ON CT_SC
FOR EACH ROW
DECLARE
    v_total NUMBER(10, 2);
BEGIN
    IF INSERTING THEN
        -- Thêm công việc vào phiếu sửa chữa
        UPDATE SUACHUA S
        SET S.TONGTIEN = S.TONGTIEN + (
            SELECT NVL(C.DONGIA, 0)
            FROM CONGVIEC C
            WHERE C.MACV = :NEW.MACV
        )
        WHERE S.MAPSC = :NEW.MAPSC;
    ELSIF DELETING THEN
        -- Xóa công việc khỏi phiếu sửa chữa
        UPDATE SUACHUA S
        SET S.TONGTIEN = S.TONGTIEN - (
            SELECT NVL(C.DONGIA, 0)
            FROM CONGVIEC C
            WHERE C.MACV = :OLD.MACV
        )
        WHERE S.MAPSC = :OLD.MAPSC;
    END IF;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        NULL; -- Xử lý ngoại lệ nếu không tìm thấy dữ liệu
END;
/

-- DIENTHOAI
INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('123456789012345', 'iPhone X', 'Smartphone', 'Nguyen Van A', '0912345678');

INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('987654321098765', 'Samsung Galaxy S9', 'Smartphone', 'Tran Thi B', '0987654321');

INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('234567890123456', 'iPhone 11', 'Smartphone', 'Le Thi C', '0912345679');

INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('345678901234567', 'Samsung Galaxy S10', 'Smartphone', 'Pham Van D', '0912345680');

INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('456789012345678', 'Huawei P30', 'Smartphone', 'Nguyen Van E', '0912345681');

INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('567890123456789', 'Oppo F11', 'Smartphone', 'Tran Thi F', '0912345682');

INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('678901234567890', 'Xiaomi Mi 9', 'Smartphone', 'Vu Van G', '0912345683');

-- Điện thoại 1
INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('789012345678901', 'Nokia 3310', 'Feature Phone', 'Hoang Van H', '0912345684');

-- Điện thoại 2
INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('890123456789012', 'Asus ROG Phone 3', 'Gaming Phone', 'Le Thi I', '0912345685');

-- Điện thoại 3
INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('901234567890123', 'Samsung Galaxy Fold', 'Foldable Phone', 'Tran Van J', '0912345686');

-- Điện thoại 4
INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('012345678901234', 'CAT S61', 'Rugged Phone', 'Pham Thi K', '0912345687');

-- Điện thoại 5
INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('123456789012346', 'Kyocera DuraForce Pro', 'Rugged Phone', 'Nguyen Van L', '0912345688');

-- Điện thoại 6
INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('234567890123457', 'Motorola Razr', 'Foldable Phone', 'Le Thi M', '0912345689');

-- Điện thoại 7
INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('345678901234568', 'Sony Xperia Play', 'Gaming Phone', 'Tran Van N', '0912345690');

-- Điện thoại 8
INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('456789012345679', 'JioPhone', 'Feature Phone', 'Pham Thi O', '0912345691');

-- Điện thoại 9
INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('567890123456780', 'Alcatel Go Flip', 'Feature Phone', 'Nguyen Van P', '0912345692');

-- Điện thoại 10
INSERT INTO DIENTHOAI (IMEI, TENDT, LOAIDT, HOTENKH, SDTKH) VALUES
('678901234567891', 'BlackBerry Bold 9900', 'Feature Phone', 'Le Thi Q', '0912345693');

-- CONGVIEC
INSERT INTO CONGVIEC (MACV, TENCV, DONGIA) VALUES
('CV001', 'Thay màn hình', 500000);

INSERT INTO CONGVIEC (MACV, TENCV, DONGIA) VALUES
('CV002', 'Thay pin', 200000);

INSERT INTO CONGVIEC (MACV, TENCV, DONGIA) VALUES
('CV003', 'Sửa loa', 150000);

INSERT INTO CONGVIEC (MACV, TENCV, DONGIA) VALUES
('CV004', 'Thay camera', 300000);

INSERT INTO CONGVIEC (MACV, TENCV, DONGIA) VALUES
('CV005', 'Thay cổng sạc', 250000);

INSERT INTO CONGVIEC (MACV, TENCV, DONGIA) VALUES
('CV006', 'Thay micro', 100000);

INSERT INTO CONGVIEC (MACV, TENCV, DONGIA) VALUES
('CV007', 'Sửa cảm biến', 200000);

INSERT INTO CONGVIEC (MACV, TENCV, DONGIA) VALUES
('CV008', 'Thay loa ngoài', 150000);

-- SUACHUA
INSERT INTO SUACHUA (NGAYLAP, NOIDUNG, IMEI) VALUES
('20/06/2023', 'Sửa chữa màn hình và pin', '123456789012345');

INSERT INTO SUACHUA (NGAYLAP, NOIDUNG, IMEI) VALUES
('21/06/2023', 'Sửa loa', '987654321098765');

INSERT INTO SUACHUA (NGAYLAP, NOIDUNG, IMEI) VALUES
('22/06/2023', 'Thay màn hình', '234567890123456');

INSERT INTO SUACHUA (NGAYLAP, NOIDUNG, IMEI) VALUES
('23/06/2023', 'Thay pin', '345678901234567');

INSERT INTO SUACHUA (NGAYLAP, NOIDUNG, IMEI) VALUES
('24/06/2023', 'Thay camera', '456789012345678');

INSERT INTO SUACHUA (NGAYLAP, NOIDUNG, IMEI) VALUES
('25/06/2023', 'Thay cổng sạc', '567890123456789');

INSERT INTO SUACHUA (NGAYLAP, NOIDUNG, IMEI) VALUES
('26/06/2023', 'Thay micro', '678901234567890');

-- CT_SC
INSERT INTO CT_SC (MAPSC, MACV) VALUES
((SELECT MAPSC FROM SUACHUA WHERE IMEI = '123456789012345' AND NGAYLAP = '20/06/2023'), 'CV001');

INSERT INTO CT_SC (MAPSC, MACV) VALUES
((SELECT MAPSC FROM SUACHUA WHERE IMEI = '123456789012345' AND NGAYLAP = '20/06/2023'), 'CV002');

INSERT INTO CT_SC (MAPSC, MACV) VALUES
((SELECT MAPSC FROM SUACHUA WHERE IMEI = '987654321098765' AND NGAYLAP = '21/06/2023'), 'CV003');

INSERT INTO CT_SC (MAPSC, MACV) VALUES
((SELECT MAPSC FROM SUACHUA WHERE IMEI = '234567890123456' AND NGAYLAP = '22/06/2023'), 'CV001');

INSERT INTO CT_SC (MAPSC, MACV) VALUES
((SELECT MAPSC FROM SUACHUA WHERE IMEI = '234567890123456' AND NGAYLAP = '22/06/2023'), 'CV002');

INSERT INTO CT_SC (MAPSC, MACV) VALUES
((SELECT MAPSC FROM SUACHUA WHERE IMEI = '345678901234567' AND NGAYLAP = '23/06/2023'), 'CV003');

INSERT INTO CT_SC (MAPSC, MACV) VALUES
((SELECT MAPSC FROM SUACHUA WHERE IMEI = '456789012345678' AND NGAYLAP = '24/06/2023'), 'CV004');

INSERT INTO CT_SC (MAPSC, MACV) VALUES
((SELECT MAPSC FROM SUACHUA WHERE IMEI = '567890123456789' AND NGAYLAP = '25/06/2023'), 'CV005');

INSERT INTO CT_SC (MAPSC, MACV) VALUES
((SELECT MAPSC FROM SUACHUA WHERE IMEI = '678901234567890' AND NGAYLAP = '26/06/2023'), 'CV006');

-- Kiểm tra
SELECT * FROM DIENTHOAI;
SELECT * FROM CONGVIEC;
SELECT * FROM SUACHUA;
SELECT * FROM CT_SC;

-- Lấy các loại điện thoại duy nhất
SELECT DISTINCT LOAIDT FROM DIENTHOAI;
